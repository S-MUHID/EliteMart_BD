<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EliteMart BD - Order Checkout</title>
    <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>
        .checkout-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-section {
            background: var(--card);
            border-radius: 10px;
            border: 1px solid #222;
            padding: 25px;
            margin-bottom: 20px;
        }

        .form-section h2 {
            color: var(--gold);
            margin: 0 0 20px 0;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--muted);
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid #222;
            border-radius: 6px;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 5px rgba(217, 178, 74, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .order-summary {
            background: var(--card);
            border-radius: 10px;
            border: 1px solid #222;
            padding: 25px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .order-summary h2 {
            color: var(--gold);
            margin: 0 0 20px 0;
            font-size: 1.3rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #222;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 10px;
        }

        .summary-item-info {
            flex: 1;
        }

        .summary-item-name {
            color: var(--gold);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .summary-item-qty {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .summary-item-price {
            color: #fff;
            font-weight: 700;
        }

        .order-total {
            background: #0f0f0f;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .total-row.grand-total {
            border-top: 2px solid var(--gold);
            padding-top: 10px;
            color: var(--gold);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .place-order-btn {
            width: 100%;
            padding: 15px;
            background: var(--gold);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .place-order-btn:hover {
            background: #e8c355;
        }

        .place-order-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .payment-method {
            margin: 15px 0;
        }

        .payment-option {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: #0f0f0f;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option:hover {
            border-color: var(--gold);
        }

        /* Validation styles for order form */
        .input-invalid {
            border-color: #d9534f !important;
            box-shadow: 0 6px 18px rgba(217,83,79,0.12);
            background: rgba(217,83,79,0.03);
        }

        .error-text {
            color: #d9534f;
            font-size: 0.85rem;
            margin-top: 6px;
            font-weight: 600;
        }

        .terms-error {
            color: #d9534f;
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 700;
        }

        .payment-option input[type="radio"] {
            width: auto;
            margin-right: 12px;
        }

        .payment-option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            color: #fff;
        }

        @media (max-width: 900px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: static;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Access Check Script -->
    <script>
        const isLoggedIn = sessionStorage.getItem('customerLoggedIn') === 'true';
        if (!isLoggedIn) {
            document.body.innerHTML = '';
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0b0b0b, #000); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            overlay.innerHTML = `
                <div style="background: linear-gradient(135deg, #0f0f0f, #0a0a0a); border: 2px solid #333; border-radius: 14px; padding: 50px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(217, 178, 74, 0.3);">
                    <h2 style="color: #d9b24a; font-size: 1.8rem; margin: 0 0 10px 0; text-shadow: 0 0 10px rgba(217, 178, 74, 0.3);">üõçÔ∏è Checkout Locked</h2>
                    <p style="color: #bdbdbd; margin: 20px 0; font-size: 1rem; line-height: 1.6;">Please log in or create an account to proceed with checkout and place your order.</p>
                    <div style="background: rgba(217, 178, 74, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #d9b24a; margin: 20px 0;">
                        <p style="color: #fff; margin: 0; font-weight: 600;">üí≥ Complete checkout after login</p>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 30px;">
                        <button onclick="location.href='customer-login.html'" style="flex: 1; padding: 12px; background: #d9b24a; color: #000; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Login Now</button>
                        <button onclick="location.href='customer-signup.html'" style="flex: 1; padding: 12px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">Create Account</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            throw new Error('Access restricted');
        }
    </script>

    <header>
        <a href="index.html" class="logo">
            <div class="mark">EM</div>
            <div>
                <h1>EliteMart BD</h1>
                <div style="color:var(--muted);font-size:0.9rem">Style that Speaks, Quality that Lasts</div>
            </div>
        </a>

        <div class="searchbar">
            <input placeholder="Search for products..." />
            <button class="searchbtn" onclick="search()">Search</button>
        </div>

        <div class="toplinks">
           
            <a class="badge" href="orders.html">üì¶ My Orders</a>
            <a class="badge" href="cart.html" style="position: relative;">
                üõí Cart
                <span class="cart-count" style="display: none;">0</span>
            </a>
        </div>
    </header>

    <div class="checkout-container">
        <h1 style="color: var(--gold); margin-bottom: 30px;">Checkout</h1>

        <div class="checkout-grid">
            <div>
                <!-- Shipping Information -->
                <div class="form-section">
                    <h2>üìç Shipping Address</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="firstName" placeholder="e.g. Ahmed" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="lastName" placeholder="e.g. Khan" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="email" placeholder="example@gmail.com" required>
                    </div>

                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="phone" placeholder="+880 1XXXXXXXXX" required>
                    </div>

                    <div class="form-group">
                        <label>Street Address *</label>
                        <input type="text" id="address" placeholder="e.g. Apartment, suite, etc." required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>City *</label>
                            <input type="text" id="city" placeholder="e.g. Dhaka" required>
                        </div>
                        <div class="form-group">
                            <label>Postal Code *</label>
                            <input type="text" id="postalCode" placeholder="e.g. 1205" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Delivery Instructions (Optional)</label>
                        <textarea id="instructions" placeholder="Leave at door, ring bell, etc." rows="3"></textarea>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="form-section">
                    <h2>üí≥ Payment Method</h2>
                    <div class="payment-method">
                        <div class="payment-option">
                            <input type="radio" id="cod" name="payment" value="cod" checked>
                            <label for="cod">Cash on Delivery (COD)</label>
                        </div>
                        <div class="payment-option" style="opacity: 0.5; cursor: not-allowed;">
                            <input type="radio" id="bkash" name="payment" value="bkash" disabled>
                            <label for="bkash" style="cursor: not-allowed;">üîµ bKash <span style="background: var(--gold); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 5px;">Coming Soon</span></label>
                        </div>
                        <div class="payment-option" style="opacity: 0.5; cursor: not-allowed;">
                            <input type="radio" id="nagad" name="payment" value="nagad" disabled>
                            <label for="nagad" style="cursor: not-allowed;">üü† Nagad <span style="background: var(--gold); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 5px;">Coming Soon</span></label>
                        </div>
                        <div class="payment-option" style="opacity: 0.5; cursor: not-allowed;">
                            <input type="radio" id="card" name="payment" value="card" disabled>
                            <label for="card" style="cursor: not-allowed;">üí≥ Credit/Debit Card <span style="background: var(--gold); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 5px;">Coming Soon</span></label>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                    <h2>üìù Additional Information</h2>
                    <div class="form-group">
                        <label>Order Notes (Optional)</label>
                        <textarea id="orderNotes" placeholder="Tell us anything about your order..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; margin: 15px 0;">
                            <input type="checkbox" id="terms" style="width: auto; margin-right: 8px;">
                            I agree to the terms and conditions
                        </label>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h2>Order Summary</h2>
                <div id="summaryItems"></div>
                <div class="order-total">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">‡ß≥0</span>
                    </div>
                    <div class="total-row">
                        <span>Discount:</span>
                        <span id="discount" style="color: #adffad;">-‡ß≥0</span>
                    </div>
                    <div class="total-row">
                        <span>Delivery:</span>
                        <span id="delivery" style="color: #adffad;">FREE</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span id="grandTotal">‡ß≥0</span>
                    </div>
                    <div style="background: #1a1a1a; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.85rem; color: #bbb;">
                        <p style="margin: 0 0 5px 0;">üì¶ <strong>Delivery Policy:</strong></p>
                        <p style="margin: 0;">‚úì Below ‡ß≥2000: Free Delivery</p>
                        <p style="margin: 0;">‚úì Above ‡ß≥2000: ‡ß≥130 Delivery Charge</p>
                    </div>
                </div>
                <button class="place-order-btn" onclick="placeOrder()">Place Order</button>
                <a href="cart.html" style="display: block; text-align: center; margin-top: 15px; color: var(--gold); text-decoration: none;">‚Üê Back to Cart</a>
            </div>
        </div>
    </div>

    <footer>
        ¬© 2025 EliteMart BD ‚Ä¢ Trusted Fashion & Lifestyle ‚Ä¢ Cash on Delivery Available Nationwide
    </footer>

    <script src="toast.js"></script>
    <script src="script.js"></script>
    <script>
        function initCheckout() {
            // Require customer login before showing checkout form
            const custLogin = sessionStorage.getItem('customerLoggedIn');
            if (custLogin !== 'true') {
                // redirect to customer login and return to this page after login
                const next = encodeURIComponent(location.pathname.split('/').pop() || 'order.html');
                location.href = `customer-login.html?next=${next}`;
                return;
            }

            if (cart.length === 0) {
                if (window.showToast) showToast('Your cart is empty! Please add items first.', 'warn'); else alert('Your cart is empty! Please add items first.');
                location.href = 'index.html';
                return;
            }

            const summaryItems = document.getElementById('summaryItems');
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = cart.reduce((sum, item) => sum + ((item.original - item.price) * item.quantity), 0);
            
            // Calculate delivery charge
            const deliveryCharge = subtotal < 2000 ? 0 : 130;
            const grandTotal = subtotal + deliveryCharge;

            summaryItems.innerHTML = cart.map(item => `
                <div class="summary-item">
                    <img src="${item.image}" alt="${item.name}" />
                    <div class="summary-item-info">
                        <div class="summary-item-name">${item.name}</div>
                        <div class="summary-item-qty">Qty: ${item.quantity}${item.size ? ' ‚Ä¢ Size: ' + item.size : ''}</div>
                    </div>
                    <div class="summary-item-price">‡ß≥${(item.price * item.quantity).toLocaleString()}</div>
                </div>
            `).join('');

            document.getElementById('subtotal').textContent = `‡ß≥${subtotal.toLocaleString()}`;
            document.getElementById('discount').textContent = `-‡ß≥${discount.toLocaleString()}`;
            document.getElementById('delivery').textContent = deliveryCharge === 0 ? 'FREE' : `‡ß≥${deliveryCharge}`;
            document.getElementById('delivery').style.color = deliveryCharge === 0 ? '#adffad' : '#ff9999';
            document.getElementById('grandTotal').textContent = `‡ß≥${grandTotal.toLocaleString()}`;

            // Pre-fill customer info if available
            const custName = sessionStorage.getItem('customerName');
            const custEmail = sessionStorage.getItem('customerEmail');
            if (custName) {
                const nameParts = custName.split(' ');
                if (nameParts.length) document.getElementById('firstName').value = nameParts[0] || '';
                if (nameParts.length>1) document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
            }
            if (custEmail) document.getElementById('email').value = custEmail;
        }

        function placeOrder() {
            // Ensure the customer is logged in before placing order
            const custLogin = sessionStorage.getItem('customerLoggedIn');
            if (custLogin !== 'true') {
                if (window.showToast) showToast('Please login to place an order. You will be redirected to the login page.', 'info'); else alert('Please login to place an order. You will be redirected to the login page.');
                const next = encodeURIComponent(location.pathname.split('/').pop() || 'order.html');
                location.href = `customer-login.html?next=${next}`;
                return;
            }

            // Validate form
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const postalCode = document.getElementById('postalCode').value.trim();
            const terms = document.getElementById('terms').checked;
                // Clear previous validation states
                function clearOrderValidation(){
                    ['firstName','lastName','email','phone','address','city','postalCode'].forEach(id=>{
                        const el = document.getElementById(id);
                        if(el) el.classList.remove('input-invalid');
                        const err = document.getElementById(id+'-error');
                        if(err) err.remove();
                    });
                    const termsErr = document.getElementById('terms-error'); if(termsErr) termsErr.remove();
                }

                function markInvalid(id, msg){
                    const el = document.getElementById(id);
                    if(!el) return;
                    el.classList.add('input-invalid');
                    if(!document.getElementById(id+'-error')){
                        const err = document.createElement('div');
                        err.id = id+'-error';
                        err.className = 'error-text';
                        err.innerText = msg || 'Required';
                        el.parentNode.appendChild(err);
                    }
                }

                clearOrderValidation();

                let hasError = false;
                if(!firstName){ markInvalid('firstName','First name is required'); hasError = true; }
                if(!lastName){ markInvalid('lastName','Last name is required'); hasError = true; }
                if(!email){ markInvalid('email','Email is required'); hasError = true; }
                if(!phone){ markInvalid('phone','Phone number is required'); hasError = true; }
                if(!address){ markInvalid('address','Address is required'); hasError = true; }
                if(!city){ markInvalid('city','City is required'); hasError = true; }
                if(!postalCode){ markInvalid('postalCode','Postal code is required'); hasError = true; }

                if(hasError){
                    if(window.showToast) showToast('Please fill in the required fields highlighted in red.', 'error'); else alert('Please fill in the required fields.');
                    // focus first invalid
                    const first = document.querySelector('.input-invalid'); if(first) first.focus();
                    return;
                }

                if(!terms){
                    const termsLabel = document.querySelector('label[for="terms"]') || document.getElementById('terms').parentNode;
                    let err = document.getElementById('terms-error');
                    if(!err){ err = document.createElement('div'); err.id = 'terms-error'; err.className = 'terms-error'; err.innerText = 'You must agree to the terms and conditions.'; termsLabel.parentNode.appendChild(err); }
                    if(window.showToast) showToast('Please agree to the terms and conditions.', 'warn'); else alert('Please agree to the terms and conditions.');
                    return;
                }

            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryCharge = subtotal < 2000 ? 0 : 130;
            const total = subtotal + deliveryCharge;

            // Create order object
            const order = {
                id: 'ORD' + Date.now(),
                date: new Date().toLocaleDateString('en-US'),
                time: new Date().toLocaleTimeString('en-US'),
                customer: {
                    firstName,
                    lastName,
                    email,
                    phone,
                    address,
                    city,
                    postalCode,
                    instructions: document.getElementById('instructions').value
                },
                items: cart,
                payment: paymentMethod,
                subtotal: subtotal,
                deliveryCharge: deliveryCharge,
                total: total,
                status: 'Pending',
                notes: document.getElementById('orderNotes').value
            };

            // Save order to localStorage
            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Remove any partial order for this session
            try {
                const partialId = sessionStorage.getItem('partialOrderId');
                if (partialId) {
                    let partials = JSON.parse(localStorage.getItem('incompleteOrders')||'[]');
                    partials = partials.filter(p => String(p.id) !== String(partialId));
                    localStorage.setItem('incompleteOrders', JSON.stringify(partials));
                    sessionStorage.removeItem('partialOrderId');
                }
            } catch(e){}

            // Clear cart
            cart = [];
            saveCart();
            updateCartCount();

            // Show success message
            if (window.showToast) showToast(`‚úì Order Placed Successfully!<br><br>Order ID: ${order.id}<br><br>We will contact you soon at ${phone} for confirmation.`, 'success', 7000);
            else alert(`‚úì Order Placed Successfully!\n\nOrder ID: ${order.id}\n\nWe will contact you soon at ${phone} for confirmation.`);

            // Redirect to orders page
            location.href = 'orders.html?id=' + order.id;
        }

        document.addEventListener('DOMContentLoaded', initCheckout);
        // Partial order (incomplete) saving: track changes and mark abandoned on unload
        (function(){
            // ensure a partial id for this session
            if (!sessionStorage.getItem('partialOrderId')) sessionStorage.setItem('partialOrderId', 'P' + Date.now());

            function gatherPartial(){
                return {
                    id: sessionStorage.getItem('partialOrderId'),
                    sessionId: sessionStorage.getItem('partialOrderId'),
                    status: 'incomplete',
                    timestamp: Date.now(),
                    progress: {
                        step: 0
                    },
                    customer: {
                        firstName: document.getElementById('firstName') ? document.getElementById('firstName').value.trim() : '',
                        lastName: document.getElementById('lastName') ? document.getElementById('lastName').value.trim() : '',
                        email: document.getElementById('email') ? document.getElementById('email').value.trim() : '',
                        phone: document.getElementById('phone') ? document.getElementById('phone').value.trim() : '',
                        address: document.getElementById('address') ? document.getElementById('address').value.trim() : '',
                        city: document.getElementById('city') ? document.getElementById('city').value.trim() : '',
                        postalCode: document.getElementById('postalCode') ? document.getElementById('postalCode').value.trim() : ''
                    },
                    items: (typeof cart !== 'undefined' ? cart : []),
                    total: (typeof cart !== 'undefined' ? cart.reduce((s,i)=>s+(i.price*i.quantity),0) : 0)
                };
            }

            function savePartial(){
                try{
                    const p = gatherPartial();
                    // determine progress step roughly: 0 none, 1 started, 2 contact filled, 3 address filled
                    let step = 0;
                    if (p.items && p.items.length>0) step = 1;
                    if (p.customer.firstName || p.customer.phone) step = 2;
                    if (p.customer.address) step = 3;
                    p.progress.step = step;

                    let partials = JSON.parse(localStorage.getItem('incompleteOrders')||'[]');
                    // replace or add
                    partials = partials.filter(x=> String(x.id) !== String(p.id));
                    partials.push(p);
                    localStorage.setItem('incompleteOrders', JSON.stringify(partials));
                }catch(e){console.warn('partial save failed',e)}
            }

            // Save on input changes
            ['firstName','lastName','email','phone','address','city','postalCode'].forEach(id=>{
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', ()=> savePartial());
            });

            // Save when cart changes - best effort: override addToCart/removeFromCart to hook saves
            const _addToCart = window.addToCart;
            if(_addToCart) window.addToCart = function(pid, size){ _addToCart(pid, size); savePartial(); };
            const _removeFromCart = window.removeFromCart;
            if(_removeFromCart) window.removeFromCart = function(pid, size){ _removeFromCart(pid, size); savePartial(); };

            // Mark abandoned on unload if still incomplete
            window.addEventListener('beforeunload', function(){
                try{
                    const p = gatherPartial();
                    p.status = 'abandoned';
                    p.timestamp = Date.now();
                    let partials = JSON.parse(localStorage.getItem('incompleteOrders')||'[]');
                    partials = partials.filter(x=> String(x.id) !== String(p.id));
                    partials.push(p);
                    localStorage.setItem('incompleteOrders', JSON.stringify(partials));
                }catch(e){}
            });
        })();
    </script>
</body>
</html>
